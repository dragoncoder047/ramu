var b=r=>e=>typeof r=="number"?r:r(e),k=class{#t;state;generators;constructor(e,n){this.#t=e,this.state={},this.generators=n}send(e){Object.assign(this.#t,e)}step(){let e=[];for(let n of this.generators){let t=n.next(Object.assign(this.state,this.#t));if(t.done)throw new Error("NoteGenerator can never finish");t&&(Object.assign(this.state,t.value?.state??{}),t.value?.notes&&e.push(...t.value.notes))}return e}};function nt(r){let t=r-1;return vt(10*3.1*t/H(1+H(10)*H(t)))}var vt=Math.abs,H=r=>r**2,Tt=4*Math.exp(-1/2)*Math.SQRT2,Z=class{random=Math.random;randrange(e,n){return Math.floor(this.random()*(n-e))+e}choose(e,n){if(n){if(n.length!=e.length)throw new Error("Weights array is not the same length as values array")}else return e[this.randrange(0,e.length)];let t=n.reduce((a,c)=>a+c,0),o=this.randrange(0,t);for(var u=0,s=0;s<e.length;s++)if(u+=n[s],u>o)return e[s];throw new Error("unreachable")}percent(e){return e>=this.randrange(1,101)}pickOne(e,n,t){let o=1/(1+Math.exp(-t));return this.choose([e,n],[1-o,o])}gaussian(e,n){var t;do{var o=this.random(),u=1-this.random();t=Tt*(o-1/2)/u;var s=t*t/4}while(s>-Math.log(u));return e+t*n}},F=new Z;function*rt(r,e=4){var n=[0,0,0,0,0];let t=[0,0,0,0,0],o=()=>{for(var c=0;c<n.length;c++)n[c]=r[c]({})};o();for(var u=0,s=yield;;){s=yield{state:{clock:t,clockBases:n,invClock:t.map((c,S)=>n[S]-c),clockRollover:u,timeSlice:60/s.tempo/n[0]}},t[0]++,u=0;for(var a=0;a<t.length&&t[a]>=n[a];a++)t[a]=0,u++,a+1<t.length&&(t[a+1]++,a+1===e&&o())}}function*ot(r,e=!0){for(yield;;)yield{state:r},e&&(r=void 0)}function*st(r,e,n){for(var t=yield,o=n(t);;)t.clockRollover>=e&&(o=n(t)),t=yield{state:{[r]:o}}}function*w(r,e){let n=[];for(var t=yield;;){let o=e({...t,history:n});n.push(o??0),t=yield{notes:o&&o>0?[{instrument:r,volume:o,duration:1}]:[]}}}function*at(r,e){for(var n=yield,t=n.root;;){if(n.clockRollover>=r){let o=Math.pow(2,Math.round(e(n))/n.notesPerOctave);t*=F.pickOne(o,-o,.5)}n=yield{state:{root:t}}}}var j={volume:.3,sampleRate:44100,x:new AudioContext,play:function(...r){return this.playSamples(this.buildSamples(...r))},playSamples:function(...r){let e=this.x.createBuffer(r.length,r[0].length,this.sampleRate),n=this.x.createBufferSource();return r.map((t,o)=>e.getChannelData(o).set(t)),n.buffer=e,n.connect(this.x.destination),n.start(),n},buildSamples:function(r=1,e=.05,n=220,t=0,o=0,u=.1,s=0,a=1,c=0,S=0,T=0,N=0,y=0,ht=0,D=0,lt=0,p=0,C=1,A=0,X=0,O=0){let h=Math.PI*2,I=yt=>yt<0?-1:1,m=this.sampleRate,ft=c*=500*h/m/m,Q=n*=(1+e*2*Math.random()-e)*h/m,P=[],d=0,pt=0,i=0,B=1,dt=0,bt=0,l=0,_,v,gt=2,$=h*Math.abs(O)*2/m,G=Math.cos($),K=Math.sin($)/2/gt,R=1+K,Mt=-2*G/R,xt=(1-K)/R,V=(1+I(O)*G)/2/R,Et=-(I(O)+G)/R,St=V,Y=0,J=0,tt=0,et=0;for(t=t*m+9,A*=m,o*=m,u*=m,p*=m,S*=500*h/m**3,D*=h/m,T*=h/m,N*=m,y=y*m|0,r*=this.volume,v=t+A+o+u+p|0;i<v;P[i++]=l*r)++bt%(lt*100|0)||(l=s?s>1?s>2?s>3?Math.sin(d*d):Math.max(Math.min(Math.tan(d),1),-1):1-(2*d/h%2+2)%2:1-4*Math.abs(Math.round(d/h)-d/h):Math.sin(d),l=(y?1-X+X*Math.sin(h*i/y):1)*I(l)*Math.abs(l)**a*(i<t?i/t:i<t+A?1-(i-t)/A*(1-C):i<t+A+o?C:i<v-p?(v-i-p)/u*C:0),l=p?l/2+(p>i?0:(i<v-p?1:(v-i)/p)*P[i-p|0]/2/r):l,O&&(l=et=St*Y+Et*(Y=J)+V*(J=l)-xt*tt-Mt*(tt=et))),_=(n+=c+=S)*Math.cos(D*pt++),d+=_+_*ht*Math.sin(i**5),B&&++B>N&&(n+=T,Q+=T,B=0),y&&!(++dt%y)&&(n=Q,c=ft,B=B||1);return P},getNote:function(r=0,e=440){return e*2**(r/12)}};var ut=[1,.05,220,0,0,.1,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0],At=[2,11,12,14,19],g=class{id;zzArray;constructor(e,n){this.zzArray=ut.map((t,o)=>n[o]??t),this.id=e}play(e,n){let t=this.zzArray.slice();return t[0]*=e.volume??1,j.play(...t)}},W=class extends g{pitchMod;constructor(e,n,t=At){super(e,n),this.pitchMod=t}play(e,n){if(!e.pitch)return;let t=this.zzArray.slice();t[0]*=e.volume??1;for(var o of this.pitchMod)t[o]*=e.pitch/(ut[o]??1);return t[4]=Math.max(0,e.duration*n-t[3]),j.play(...t)}};function L(r=0){return e=>+(e.clockRollover>=r)}function q(r,e=0){let n=L(e-1);return t=>{if(!n(t))return 0;let o=t.clock[e];return t.clockBases[e]*r>o?1:0}}function z(r){return e=>2-nt(Math.pow(2,-e.notesPerOctave)*r)}function M(r,e=2){let n=b(r);return t=>{let o=n(t);if(!o)return;let u=o*t.clockBases.slice(e).reduce((s,a)=>s*a,1);return t.history.at(-u)}}function x(r,e){let n=b(r),t=b(e);return o=>{let u=o.history,s=Math.round(t(o)),a=u.slice(-s),c=n(o),S=a.reduce((T,N)=>T+N,0)/a.length-c;return 1/(1+Math.exp(-S))}}function f(...r){let e=r.map(n=>Array.isArray(n)?[b(n[0]),b(n[1])]:[b(n),()=>1]);return n=>{let t=e.map(([s,a])=>[s(n),a(n)??1]),o=t.flatMap(([s,a])=>s!==void 0&&!isNaN(a)?[s]:[]),u=t.flatMap(([s,a])=>s!==void 0&&!isNaN(a)?[a]:[]);if(!(o.length===0||u.every(s=>s===0)))return F.choose(o,u)}}function E(...r){let e=r.map(b);return n=>e.map(t=>t(n)).reduce((t,o)=>(t??0)*(o??0),1)}var Wt={},U=new k(Wt,[ot({root:220*Math.pow(2,7/12),notesPerOctave:12,tempo:128}),rt({0:f([4,2],[3,1]),1:f([2,50],[3,50],[4,100],[5,4],[6,20],[7,2],[8,50],[9,6],[11,1]),2:f([4,10],[5,2],[8,2]),3:f([4,10],[2,1],[6,2],[1,5]),4:()=>1}),w("bass",f([1,E(500,L(1))],[.2,1],[0,100],[x(.25,4),E(x(.25,4),20)],[M(r=>r.clockBases?.[1],1),100],[M(r=>r.clockBases?.[2],2),50])),w("snare",f([q(.5,2),500],[.2,1],[0,10],[x(.2,4),E(x(.8,4),20)],[M(r=>r.clockBases?.[1],1),100],[M(r=>r.clockBases?.[2],2),50])),w("hi-hat",f([1,E(L(1),10)],[.8,E(q(.5,1),10)],[0,10],[x(.8,4),E(x(.2,4),20)],[M(r=>r.clockBases?.[1],1),100],[M(r=>r.clockBases?.[2],2),50])),st("notesPerOctave",4,f([12,1e3],[24,200],[31,2],[33,2],[43,3])),at(4,f([1,z(1)],[2,z(2)],[3,z(3)]))]),Nt=[new g("snare",[2,0,660,,,.09,3,,,,,,.2,2,,,,1.1]),new g("bass",[4,0,80,,,.2,1,4,-2,6,50,.15,,6]),new g("hi-hat",[,0,3520,,,.11,3,1.65,,,,,,2]),new W("square",[,0,,,1,,,0,,,,,,,,,,.8,.05]),new W("sine",[,0,,,1,,,,,,,,,,,,,.8,.05])];function ct(){U.step().forEach(e=>{e.instrument&&Nt.find(n=>n.id===e.instrument)?.play(e,U.state.timeSlice)}),Ot.textContent=JSON.stringify(U.state,void 0,2),setTimeout(ct,U.state.timeSlice*1e3)}var mt=r=>document.querySelector(r),it=mt("#start"),Ot=mt("#data");it.addEventListener("click",()=>{it.remove(),ct()});
//# sourceMappingURL=ramu.js.map
