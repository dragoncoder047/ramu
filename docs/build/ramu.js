var E=class{random=Math.random;randrange(t,e){return Math.floor(this.random()*(e-t))+t}choose(t,e){if(e){if(e.length!=t.length)throw new Error("Weights array is not the same length as values array")}else return t[this.randrange(0,t.length)];let r=e.reduce((P,T)=>P+T,0),o=this.randrange(0,r);for(var m=0,c=0;c<t.length;c++)if(m+=e[c],m>o)return t[c];throw"unreachable"}percent(t){return t>=this.randrange(1,101)}pickOne(t,e,r){let o=1/(1+Math.exp(-r));return this.random()>o?t:e}},Y=new E;var G=class{noteHistory;timeLeftInCurrentNote;rules;constructor(t){this.rules=t,this.noteHistory=[],this.timeLeftInCurrentNote=0}apply(t,e){throw new Error("Please implement this method")}reduceRules(t,e){if(!this.rules||this.rules.length===0)throw new Error("No rules to reduce");let r=[],o=[];for(var m of this.rules)r.push(m.getNote(t,this,e)),o.push(m.getWeight(t,this,e));return Y.choose(r,o)}step(t,e){let r=1/t.data.notesPerBeat;if(this.timeLeftInCurrentNote-=r,this.timeLeftInCurrentNote>0)return;let o=this.apply(t,e);return o&&(this.noteHistory.push(o),this.timeLeftInCurrentNote=o.duration),o}getNoteAt(t=0){if(t>0)throw new Error("Can't get future note before it happens");let e=this.noteHistory;if(!e.length)return;var r=e.length-1;for(t+=this.timeLeftInCurrentNote;r>=0&&t<=0;)t+=e[r].duration,r--;let o=r>=0?e[r]:void 0;if(o)return{...o,duration:t}}};var I=class extends G{apply(t,e){return{duration:this.reduceRules(t,e).duration}}},l=class extends I{instrument;constructor(t,e){super(t),this.instrument=e}apply(t,e){return{...super.apply(t,e),instrument:this.instrument}}};var _={volume:.3,sampleRate:44100,x:new AudioContext,play:function(...n){return this.playSamples(this.buildSamples(...n))},playSamples:function(...n){let t=this.x.createBuffer(n.length,n[0].length,this.sampleRate),e=this.x.createBufferSource();return n.map((r,o)=>t.getChannelData(o).set(r)),e.buffer=t,e.connect(this.x.destination),e.start(),e},buildSamples:function(n=1,t=.05,e=220,r=0,o=0,m=.1,c=0,P=1,T=0,L=0,y=0,H=0,p=0,J=0,O=0,k=0,g=0,R=1,x=0,F=0,S=0){let u=Math.PI*2,U=ht=>ht<0?-1:1,a=this.sampleRate,tt=T*=500*u/a/a,Z=e*=(1+t*2*Math.random()-t)*u/a,z=[],d=0,et=0,s=0,w=1,nt=0,rt=0,h=0,B,f,ot=2,j=u*Math.abs(S)*2/a,C=Math.cos(j),q=Math.sin(j)/2/ot,v=1+q,st=-2*C/v,it=(1-q)/v,X=(1+U(S)*C)/2/v,at=-(U(S)+C)/v,ut=X,$=0,D=0,K=0,Q=0;for(r=r*a+9,x*=a,o*=a,m*=a,g*=a,L*=500*u/a**3,O*=u/a,y*=u/a,H*=a,p=p*a|0,n*=this.volume,f=r+x+o+m+g|0;s<f;z[s++]=h*n)++rt%(k*100|0)||(h=c?c>1?c>2?c>3?Math.sin(d*d):Math.max(Math.min(Math.tan(d),1),-1):1-(2*d/u%2+2)%2:1-4*Math.abs(Math.round(d/u)-d/u):Math.sin(d),h=(p?1-F+F*Math.sin(u*s/p):1)*U(h)*Math.abs(h)**P*(s<r?s/r:s<r+x?1-(s-r)/x*(1-R):s<r+x+o?R:s<f-g?(f-s-g)/m*R:0),h=g?h/2+(g>s?0:(s<f-g?1:(f-s)/g)*z[s-g|0]/2/n):h,S&&(h=Q=ut*$+at*($=D)+X*(D=h)-it*K-st*(K=Q))),B=(e+=T+=L)*Math.cos(O*et++),d+=B+B*J*Math.sin(s**5),w&&++w>H&&(e+=y,Z+=y,w=0),p&&!(++nt%p)&&(e=Z,T=tt,w=w||1);return z},getNote:function(n=0,t=440){return t*2**(n/12)}};var mt=[1,.05,220,0,0,.1,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0];var N=class{id;zzArray;constructor(t,e){this.zzArray=mt.map((r,o)=>e[o]??r),this.id=t}play(t){let e=this.zzArray.slice();return e[0]*=t?.volume??1,_.play(...e)}};var M=class{getNote(t,e,r){throw new Error("Please implement this method")}getWeight(t,e,r){throw new Error("Please implement this method")}},i=class extends M{value;getWeight;constructor(t,e){super(),this.value=t,this.getWeight=e}getNote(){return this.value}};var b=class extends M{getWeight;constructor(t){super(),this.getWeight=t}getNote(t,e){return{duration:1-t.getState().beatPos}}};var A=class{data;#e;#t;constructor(t){this.data=t,this.#e=[],this.#t={time:0,beatPos:0}}send(t){Object.assign(this.data.uniforms,t)}step(){let t=[];for(let e of this.data.generators){let r=e.step(this,t);r&&t.push(r)}return this.#t.time+=1/this.data.notesPerBeat,this.#t.beatPos=this.#t.time%1,this.#e.push({...this.#t}),t}getState(t=0){if(t>0)throw new Error("Can't get future state before it happens");return t===0?this.#t:this.#e.at(t)}pitchToFrequency(t){return this.data.root*Math.pow(2,t/this.data.notesPerOctave)}};var ct={repetitiveness:5,beatStrength:5},W={root:220*Math.pow(2,7/12),notesPerOctave:12,tempo:120,notesPerBeat:4,uniforms:ct,generators:[new l([new i({duration:1},()=>10),new i({duration:.5},()=>8),new i({duration:.25},()=>1),new i({duration:.75},()=>1),new b(n=>n.data.uniforms.repetitiveness*n.data.uniforms.beatStrength)],"snare"),new l([new i({duration:1},()=>10),new i({duration:.5},()=>8),new i({duration:.25},()=>1),new i({duration:.75},()=>1),new b(n=>2*n.data.uniforms.repetitiveness*n.data.uniforms.beatStrength)],"bass"),new l([new i({duration:1},()=>4),new i({duration:.5},()=>8),new i({duration:.25},()=>10),new i({duration:.75},()=>1),new b(n=>1/10*n.data.uniforms.repetitiveness*n.data.uniforms.beatStrength)],"hihat")]},gt=new A(W),dt=[new N("snare",[2,0,660,,,.09,3,,,,,,.2,2,,,,1.1]),new N("bass",[4,0,80,,,.2,1,4,-2,6,50,.15,,6]),new N("hihat",[,0,3520,,,.11,3,1.65,,,,,,2])];function pt(){gt.step().forEach(t=>{t.instrument&&dt.find(e=>e.id===t.instrument)?.play(t)})}var ft=n=>document.querySelector(n),V=ft("#start");V.addEventListener("click",()=>{V.remove(),setInterval(pt,6e4/(W.tempo*W.notesPerBeat))});
//# sourceMappingURL=ramu.js.map
