var V={volume:.3,sampleRate:44100,x:new AudioContext,play:function(...r){return this.playSamples(this.buildSamples(...r))},playSamples:function(...r){let t=this.x.createBuffer(r.length,r[0].length,this.sampleRate),e=this.x.createBufferSource();return r.map((n,o)=>t.getChannelData(o).set(n)),e.buffer=t,e.connect(this.x.destination),e.start(),e},buildSamples:function(r=1,t=.05,e=220,n=0,o=0,c=.1,s=0,a=1,m=0,W=0,A=0,v=0,x=0,rt=0,I=0,ot=0,p=0,w=1,T=0,j=0,O=0){let h=Math.PI*2,L=lt=>lt<0?-1:1,i=this.sampleRate,st=m*=500*h/i/i,G=e*=(1+t*2*Math.random()-t)*h/i,z=[],l=0,at=0,u=0,B=1,ct=0,ut=0,f=0,C,M,it=2,Z=h*Math.abs(O)*2/i,U=Math.cos(Z),q=Math.sin(Z)/2/it,N=1+q,mt=-2*U/N,ht=(1-q)/N,D=(1+L(O)*U)/2/N,ft=-(L(O)+U)/N,pt=D,X=0,$=0,K=0,Q=0;for(n=n*i+9,T*=i,o*=i,c*=i,p*=i,W*=500*h/i**3,I*=h/i,A*=h/i,v*=i,x=x*i|0,r*=this.volume,M=n+T+o+c+p|0;u<M;z[u++]=f*r)++ut%(ot*100|0)||(f=s?s>1?s>2?s>3?Math.sin(l*l):Math.max(Math.min(Math.tan(l),1),-1):1-(2*l/h%2+2)%2:1-4*Math.abs(Math.round(l/h)-l/h):Math.sin(l),f=(x?1-j+j*Math.sin(h*u/x):1)*L(f)*Math.abs(f)**a*(u<n?u/n:u<n+T?1-(u-n)/T*(1-w):u<n+T+o?w:u<M-p?(M-u-p)/c*w:0),f=p?f/2+(p>u?0:(u<M-p?1:(M-u)/p)*z[u-p|0]/2/r):f,O&&(f=Q=pt*X+ft*(X=$)+D*($=f)-ht*K-mt*(K=Q))),C=(e+=m+=W)*Math.cos(I*at++),l+=C+C*rt*Math.sin(u**5),B&&++B>v&&(e+=A,G+=A,B=0),x&&!(++ct%x)&&(e=G,m=st,B=B||1);return z},getNote:function(r=0,t=440){return t*2**(r/12)}};var dt=[1,.05,220,0,0,.1,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0];var S=class{id;zzArray;constructor(t,e){this.zzArray=dt.map((n,o)=>e[o]??n),this.id=t}play(t,e){let n=this.zzArray.slice();return n[0]*=t.volume??1,V.play(...n)}};var d=r=>t=>typeof r=="number"?r:r(t),k=class{data;state;constructor(t){this.data=t,this.state={...t.uniforms}}send(t){Object.assign(this.data.uniforms,t)}step(){let t=[];for(let e of this.data.generators){let n=e.next(Object.assign(this.state,this.data.uniforms));if(n.done)throw new Error("NoteGenerator can never finish");n&&(Object.assign(this.state,n.value.state),n.value.notes&&t.push(...n.value.notes))}return t}pitchToFrequency(t){return this.data.root*Math.pow(2,t/this.data.notesPerOctave)}};var _=class{random=Math.random;randrange(t,e){return Math.floor(this.random()*(e-t))+t}choose(t,e){if(e){if(e.length!=t.length)throw new Error("Weights array is not the same length as values array")}else return t[this.randrange(0,t.length)];let n=e.reduce((a,m)=>a+m,0),o=this.randrange(0,n);for(var c=0,s=0;s<t.length;s++)if(c+=e[s],c>o)return t[s];throw new Error("unreachable")}percent(t){return t>=this.randrange(1,101)}pickOne(t,e,n){let o=1/(1+Math.exp(-n));return this.choose([t,e],[1-o,o])}},Y=new _;function R(r=0){return t=>t?.clock?.slice(0,r).every(e=>e===0)?1:0}function H(r,t=0){let e=R(t-1);return n=>{if(!e(n))return 0;let o=(n?.clock)[t];return(n?.clockBases)[t]*r>o?1:0}}function b(r,t=2){let e=d(r);return n=>{let o=e(n);if(!o)return;let c=o*n.clockBases.slice(t).reduce((s,a)=>s*a,1);return n.history.at(-c)}}function g(r,t){let e=d(r),n=d(t);return o=>{let c=o.history,s=Math.round(n(o)),a=c.slice(-s),m=e(o),W=a.reduce((A,v)=>A+v,0)/a.length-m;return 1/(1+Math.exp(-W))}}function y(...r){let t=r.map(e=>Array.isArray(e)?[d(e[0]),d(e[1])]:[d(e),()=>1]);return e=>{let n=t.map(([s,a])=>[s(e),a(e)??1]),o=n.flatMap(([s,a])=>s!==void 0&&!isNaN(a)?[s]:[]),c=n.flatMap(([s,a])=>s!==void 0&&!isNaN(a)?[a]:[]);if(console.log(o,c),!(o.length===0||c.every(s=>s===0)))return Y.choose(o,c)}}function E(...r){let t=r.map(d);return e=>t.map(n=>n(e)).reduce((n,o)=>(n??0)*(o??0),1)}function*J(r,t=4){var e=[0,0,0,0,0];let n=[0,0,0,0,0],o=Object.fromEntries(Object.entries(r).map(([a,m])=>[a,y(...m)])),c=()=>{for(var a=0;a<e.length;a++)e[a]=o[a]({})};for(c();;){yield{state:{clock:n,clockBases:e,invClock:n.map((a,m)=>e[m]-a)}},n[0]++;for(var s=0;s<n.length&&n[s]>=e[s];s++)n[s]=0,s+1<n.length&&(n[s+1]++,s+1===t&&c())}}function*F(r,t){let e=[];for(var n={};;){let o=t({...n,history:e});e.push(o??0),n=yield{notes:o&&o>0?[{instrument:r,volume:o,duration:1}]:[]}}}var gt={},Et={root:220*Math.pow(2,7/12),notesPerOctave:12,tempo:128,uniforms:gt,generators:[J({0:[[4,10],[3,5]],1:[[2,50],[3,50],[4,100],[5,4],[6,20],[7,2],[8,50],[9,6],[11,1]],2:[[4,10],[5,2],[2,2]],3:[[4,10],[2,1],[6,2]],4:[1]}),F("bass",y([1,E(500,R(1))],[.2,1],[0,100],[g(.25,4),E(g(.25,4),20)],[b(r=>r.clockBases?.[1],1),100],[b(r=>r.clockBases?.[2],2),50])),F("snare",y([H(.5,2),500],[.2,1],[0,10],[g(.2,4),E(g(.8,4),20)],[b(r=>r.clockBases?.[1],1),100],[b(r=>r.clockBases?.[2],2),50])),F("hi-hat",y([1,E(R(1),10)],[.8,E(H(.5,1),10)],[0,10],[g(.8,4),E(g(.2,4),20)],[b(r=>r.clockBases?.[1],1),100],[b(r=>r.clockBases?.[2],2),50]))]},P=new k(Et),xt=[new S("snare",[2,0,660,,,.09,3,,,,,,.2,2,,,,1.1]),new S("bass",[4,0,80,,,.2,1,4,-2,6,50,.15,,6]),new S("hi-hat",[,0,3520,,,.11,3,1.65,,,,,,2])];function nt(){let r=P.step(),t=60/P.data.tempo/P.state.clockBases[0];r.forEach(e=>{e.instrument&&xt.find(n=>n.id===e.instrument)?.play(e,t)}),Mt.textContent=JSON.stringify(P.state,void 0,2),setTimeout(nt,t*1e3)}var et=r=>document.querySelector(r),tt=et("#start"),Mt=et("#data");tt.addEventListener("click",()=>{tt.remove(),nt()});
//# sourceMappingURL=ramu.js.map
